<!DOCTYPE html>
<html>
        <head>
        <meta charset="utf-8" />
        <title>WS Space Client</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
        html, body { height: 100%;background-color: black; color: antiquewhite; margin: 0; font-family: system-ui, sans-serif; }
        .wrap { display: grid; grid-template-columns: 320px 1fr;
            gap: 16px; 
            height: 100%; }
        aside { padding: 16px; border-right: 1px solid #eee; }
        label { display: block; font-size: 12px; color: #555; margin-top: 8px; }
        input { width: 100%; padding: 8px; box-sizing: border-box; }
        button { padding: 8px 12px; margin-top: 12px; cursor: pointer; }
        .log { height: 240px; overflow: auto; background: #fafafa; border: 1px solid #eee; padding: 8px; font-family: ui-monospace, Menlo, monospace; font-size: 12px; }
        canvas { width: 800px; height: 600px; display: block; background: rgb(167, 75, 75)000f6; }
        .hint { font-size: 12px; color: #666; }
        ul { padding-left: 18px; }
        .badge { display:inline-block; padding:2px 6px; border-radius: 8px; background-color:#000000; font-size:11px; }
        </style>
        </head>
        <body>
        <div class="wrap">
        <aside>
        <h2>Connect</h2>
        <label>WS URL</label>
        <input id="wsUrl" value="ws://localhost:3001" />
        <label>spaceId</label>
        <input id="spaceId" placeholder="space id" />
        <label>JWT token</label>
        <input id="token" placeholder="jwt" />
        <button id="connectBtn">Connect & Join</button>
        <p class="hint">After connecting, use the arrow keys to move one tile at a time.</p>
        <h3>Users <span class="badge" id="userCount">0</span></h3>
        <ul id="userList"></ul>
        <h3>Log</h3>
        <div class="log" id="log"></div>
        </aside>
        <main  style="display: flex; justify-content: center; align-items: center;">
        <canvas style=" background-color: rgb(107, 86, 86);" id="board" width="600" height="600"></canvas>
        </main>
        </div>
        <script>
        let socket = null;
        let joined = false;
        let myPos = { x: null, y: null };
        const others = new Map();
        const $ = (id) => document.getElementById(id);
        const log = (msg, obj) => {
        const el = $("log");
        const line = document.createElement("div");
        line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        el.appendChild(line);
        el.scrollTop = el.scrollHeight;
        if (obj) console.debug(msg, obj);
        };
        const renderUserList = () => {
        const ul = $("userList");
        ul.innerHTML = "";
        for (const [id, pos] of others.entries()) {
        const li = document.createElement("li");
        li.textContent = `${id} @ (${pos.x}, ${pos.y})`;
        ul.appendChild(li);
        }
        $("userCount").textContent = String(others.size);
        };
        const canvas = $("board");
        const ctx = canvas.getContext("2d");
        const tile = 40;
        function drawGrid() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.lineWidth = 1;
        ctx.strokeStyle = "#eee";
        for (let x = 0; x <= canvas.width; x += tile) {
        ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
        }
        for (let y = 0; y <= canvas.height; y += tile) {
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
        }
        for (const [, pos] of others.entries()) {
        if (pos.x == null) continue;
        drawDot(pos.x, pos.y, false);
        }
        if (myPos.x != null) drawDot(myPos.x, myPos.y, true);
        }
        function drawDot(gridX, gridY, me = false) {
        const cx = gridX * tile + tile / 2;
        const cy = gridY * tile + tile / 2;
        ctx.beginPath();
        ctx.arc(cx, cy, tile * 0.35, 0, Math.PI * 2);
        ctx.fillStyle = me ? "#1e90ff" : "#ff6347";
        ctx.fill();
        }
        drawGrid();
        $("connectBtn").addEventListener("click", () => {
        const url = $("wsUrl").value.trim();
        const spaceId = $("spaceId").value.trim();
        const token = $("token").value.trim();
        if (!url || !spaceId || !token) {
        alert("Please fill WS URL, spaceId, and token");
        return;
        }
        if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
        try { socket.close(); } catch {}
        }
        socket = new WebSocket(url);
        socket.onopen = () => {
        log("WS connected. Sending join...");
        socket.send(JSON.stringify({ type: "join", payload: { spaceId, token } }));
        };
        socket.onmessage = (ev) => {
        let msg = null;
        try { msg = JSON.parse(ev.data); } catch (e) { log("Non-JSON message", ev.data); return; }
        log(`<= ${msg.type}`);
        switch (msg.type) {
        case "space-joined": {
        myPos.x = msg.payload && msg.payload.spawn ? msg.payload.spawn.x : 0;
        myPos.y = msg.payload && msg.payload.spawn ? msg.payload.spawn.y : 0;
        joined = true;
        others.clear();
        const list = (msg.payload && msg.payload.users) ? msg.payload.users : [];
        for (const u of list) {
        const uid = u.userId || u.id;
        if (!uid) continue;
        others.set(uid, { x: u.x ?? null, y: u.y ?? null });
        }
        renderUserList();
        drawGrid();
        break;
        }
        case "user-joined": {
        const p = msg.payload || {};
        const uid = p.userId || p.id;
        if (uid) {
        others.set(uid, { x: p.x, y: p.y });
        renderUserList();
        drawGrid();
        }
        break;
        }
        case "movement": {
        const p = msg.payload || {};
        const uid = p.userId || p.id;
        if (uid && others.has(uid)) {
        others.set(uid, { x: p.x, y: p.y });
        drawGrid();
        }
        break;
        }
        case "movement-rejected": {
        myPos.x = msg.payload.x;
        myPos.y = msg.payload.y;
        drawGrid();
        break;
        }
        case "user-left": {
        const p = msg.payload || {};
        const uid = p.userId || p.id;
        if (uid) {
        others.delete(uid);
        renderUserList();
        drawGrid();
        }
        break;
        }
        }
        };
        socket.onclose = () => { log("WS closed"); joined = false; };
        socket.onerror = (e) => log("WS error", e);
        });
        document.addEventListener("keydown", (e) => {
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
        if (["input","textarea","select"].includes(tag)) return;
        let handled = false;
        if (e.key === "ArrowUp") { handled = true; 
            if (joined && socket && socket.readyState === WebSocket.OPEN && myPos.x != null) { const nx = myPos.x;
                const ny = myPos.y - 1;
                socket.send(JSON.stringify({ type: "move", payload: { x: nx, y: ny } })); 
                myPos.x = nx; myPos.y = ny; drawGrid(); } }
        else if (e.key === "ArrowDown") 
        { handled = true; if (joined && socket && socket.readyState === WebSocket.OPEN && myPos.x != null) 
            { const nx = myPos.x; 
                const ny = myPos.y + 1; 
                socket.send(JSON.stringify({ type: "move", payload: { x: nx, y: ny } })); 
                myPos.x = nx; myPos.y = ny; 
                drawGrid(); 
            } }
        else if (e.key === "ArrowLeft") 
        { handled = true; 
            if (joined && socket && socket.readyState === WebSocket.OPEN && myPos.x != null) 
            { const nx = myPos.x - 1;
                const ny = myPos.y; socket.send(JSON.stringify({ type: "move", payload: { x: nx, y: ny } })); 
                myPos.x = nx; myPos.y = ny; drawGrid(); } }
        else if (e.key === "ArrowRight") 
        { handled = true; 
            if (joined && socket && socket.readyState === WebSocket.OPEN && myPos.x != null) 
            { const nx = myPos.x + 1; 
                const ny = myPos.y; 
                socket.send(JSON.stringify({ type: "move", payload: { x: nx, y: ny } })); 
                myPos.x = nx; 
                myPos.y = ny; 
                drawGrid(); } }
        if (handled) 
        e.preventDefault();
        });
        </script>
        </body>
</html>
